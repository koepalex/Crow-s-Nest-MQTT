# Test Environment Setup

This document describes the test environment configuration for Crow's Nest MQTT, including test data generation for export/copy functionality with correlation data.

## Test Project Structure

```
tests/
â”œâ”€â”€ UnitTests/                  # Unit tests (existing)
â”œâ”€â”€ contract/                   # Contract tests (existing)
â”œâ”€â”€ integration/                # Integration tests (new)
â”œâ”€â”€ TestData/                   # Shared test data generators and utilities
â”‚   â”œâ”€â”€ MqttTestDataGenerator.cs    # Test message generation with correlation data
â”‚   â””â”€â”€ MqttTestUtilities.cs        # MQTT broker and client test helpers
â””â”€â”€ README.md                   # This file
```

## Test Environment Components

### 1. Embedded MQTT Broker
- **Location**: `MqttBrokerFixture.cs` (existing), `MqttTestUtilities.cs` (enhanced)
- **Purpose**: Provides in-memory MQTT broker for integration tests
- **Features**:
  - Automatic port allocation to avoid conflicts
  - Clean session handling for isolated test runs
  - Configurable timeout and retry settings

### 2. Test Data Generation
- **Location**: `MqttTestDataGenerator.cs`
- **Purpose**: Creates MQTT messages with various correlation data formats
- **Test Scenarios**:
  - Simple correlation IDs (`correlation-id-12345`)
  - Binary correlation data with hex bytes
  - UUID correlation data (16-byte GUID format)
  - Unicode/International characters (`ĞºĞ¾Ñ€Ñ€ĞµĞ»ÑÑ†Ğ¸Ñ-æµ‹è¯•-ğŸ”—`)
  - Special characters and symbols (`!@#$%^&*()_+-={}|[]\\:\";'<>?,./`)
  - Empty correlation data (empty byte array)
  - Null correlation data
  - Large correlation data (1000+ characters)
  - JSON in correlation data (`{"requestId":"req-001","user":"admin"}`)
  - Base64 encoded data

### 3. Test Utilities
- **Location**: `MqttTestUtilities.cs`
- **Features**:
  - Embedded broker lifecycle management
  - Test client creation and connection handling
  - Message publishing with proper timing
  - Message collection and verification helpers
  - Condition waiting utilities for async testing

## Configuration Files

### Unit Tests Configuration
- **File**: `tests/UnitTests/appsettings.test.json`
- **Purpose**: Configuration for unit test MQTT broker
- **Settings**:
  - Hostname: `localhost`
  - Port: `11883` (configurable)

### Integration Tests Configuration
- **File**: `tests/integration/appsettings.integration.json`
- **Purpose**: Configuration for integration test environment
- **Settings**:
  - MQTT broker connection details
  - Test data generation parameters
  - Export directory settings
  - Cleanup configuration

## Test Data Categories

### Correlation Data Test Messages
Generated by `GetCorrelationDataTestMessages()`:

1. **Simple Text**: Basic string correlation ID
2. **Binary Data**: Raw byte arrays with various patterns
3. **UUID Format**: Standard GUID as correlation data
4. **Unicode Content**: International characters and emojis
5. **Special Characters**: Symbols and escape characters
6. **Edge Cases**: Empty, null, and very large correlation data
7. **Structured Data**: JSON and Base64 encoded content

### User Properties Test Messages
Generated by `GetUserPropertiesTestMessages()`:

1. **Simple Properties**: Basic key-value pairs
2. **Unicode Properties**: International property names and values
3. **Complex Properties**: Multiple properties with various data types

### Edge Case Test Messages
Generated by `GetEdgeCaseTestMessages()`:

1. **Binary Payloads**: Non-text message content (PNG, binary data)
2. **Long Topic Names**: Very long MQTT topic paths
3. **Complete MQTT 5.0**: All properties filled with valid data

## Running Tests

### Prerequisites
- .NET 10.0 or later
- xUnit test runner
- Available TCP ports for embedded MQTT broker

### Unit Tests
```bash
cd tests/UnitTests
dotnet test
```

### Integration Tests
```bash
cd tests/integration
dotnet test
```

### All Tests
```bash
# From project root
dotnet test
```

## Test Configuration

### MQTT Broker Settings
The test environment supports both embedded and external MQTT brokers:

- **Embedded Broker**: Started automatically, uses random ports
- **External Broker**: Configure in `appsettings.*.json` files
- **Connection Timeout**: 5 seconds default
- **Message Delay**: 10ms between published messages

### Test Data Cleanup
- Export files are created in temporary directories
- Automatic cleanup after test completion
- Configurable retention for debugging

## Usage Examples

### Basic Test Setup
```csharp
public class ExampleIntegrationTest : IAsyncLifetime
{
    private readonly MqttTestUtilities _mqttUtils = new();

    public async Task InitializeAsync()
    {
        await _mqttUtils.StartEmbeddedBrokerAsync();
    }

    [Fact]
    public async Task TestCorrelationDataExport()
    {
        // Get test messages with correlation data
        var testMessages = MqttTestDataGenerator.GetCorrelationDataTestMessages();

        // Create client and publish
        var client = await _mqttUtils.CreateConnectedTestClientAsync();
        await _mqttUtils.PublishTestMessagesAsync(client, testMessages);

        // Test export functionality
        var exporter = new TextExporter();
        foreach (var message in testMessages)
        {
            var exported = exporter.ExportToFile(message.Message, message.ReceivedTimestamp, testDir);
            Assert.True(File.Exists(exported));
        }
    }

    public async Task DisposeAsync() => await _mqttUtils.DisposeAsync();
}
```

### Message Collection Testing
```csharp
[Fact]
public async Task TestMessageCollection()
{
    var collector = await _mqttUtils.CreateMessageCollectorAsync("test/+/data");

    // Publish test data
    await _mqttUtils.PublishTestMessagesAsync(publisher, testMessages);

    // Wait for messages
    await collector.WaitForMessagesAsync(expectedCount: 5, timeout: TimeSpan.FromSeconds(10));

    // Verify correlation data
    var messagesWithCorrelation = collector.GetMessagesWithCorrelationData();
    Assert.NotEmpty(messagesWithCorrelation);
}
```

## Integration with CI/CD

The test environment is designed to work in CI/CD pipelines:

- No external dependencies required (embedded broker)
- Automatic port allocation prevents conflicts
- Configurable timeouts for different environments
- Detailed test output for debugging
- Proper resource cleanup

## Troubleshooting

### Common Issues

1. **Port Conflicts**: Embedded broker uses random ports to avoid conflicts
2. **Timeout Issues**: Increase timeouts in configuration for slower environments
3. **File Cleanup**: Temporary directories are automatically cleaned up
4. **Encoding Issues**: Test data includes Unicode scenarios to verify proper handling

### Debug Configuration

Enable detailed logging in test configuration:
```json
{
  "TestConfiguration": {
    "DetailedLogging": true,
    "LogMessageContents": true,
    "RetainTestFiles": true
  }
}
```

This test environment provides comprehensive coverage for export/copy functionality with correlation data, ensuring robust testing of MQTT message handling across various scenarios and edge cases.