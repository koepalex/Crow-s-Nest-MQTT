<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:CrowsNestMqtt.UI.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="CrowsNestMqtt.UI.Views.MainView"
             x:DataType="vm:MainViewModel">

  <Design.DataContext>
    <!-- This DataContext is used only for design-time IntelliSense. -->
    <!-- It is overridden at runtime by the ViewModel assigned in code-behind -->
    <vm:MainViewModel />
  </Design.DataContext>

  <!-- Changed RowDefinitions to Auto,Auto,*, removed ColumnDefinitions from top Grid -->
  <!-- Use a root Panel for layering -->
  <Panel>
    <!-- Main layout Grid (without settings) -->
    <Grid RowDefinitions="Auto,Auto,*" ColumnDefinitions="*">
 
      <!-- Top Command/Search Bar -->
      <TextBox Grid.Row="0"
               Watermark="Enter command or search query..."
               Text="{Binding CommandText}"
               Margin="5"/>
 
      <!-- Buttons and Status Indicators -->
      <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="5" Margin="5,0,5,5">
          <Button Content="Connect" Command="{Binding ConnectCommand}" />
          <Button Content="Disconnect" Command="{Binding DisconnectCommand}" />
          <Button Content="Simulate Msg" Command="{Binding SimulateMessageCommand}" />
          <Button Content="Clear History" Command="{Binding ClearHistoryCommand}" />
          <Button Content="Pause/Resume" Command="{Binding PauseResumeCommand}" />
          <Button Content="Settings" Command="{Binding OpenSettingsCommand}" Margin="10,0,0,0" />
          <TextBlock Text="Status:" VerticalAlignment="Center" Margin="10,0,0,0"/>
          <TextBlock Text="{Binding IsConnected, StringFormat='Connected: {0}'}" VerticalAlignment="Center" Margin="5,0"/>
          <TextBlock Text="{Binding IsPaused, StringFormat='Paused: {0}'}" VerticalAlignment="Center" Margin="5,0"/>
      </StackPanel>
 
      <!-- Main Content Area using DockPanel -->
          <Grid Grid.Row="2" RowDefinitions="*" ColumnDefinitions="*,Auto">
          <!-- Main Content Grid (Fills Remaining Space) -->
          <!-- Changed ColumnDefinitions to add a splitter, removed DockPanel.Dock -->
          <Grid Grid.Row="0" Grid.Column="0" ColumnDefinitions="1*,Auto,3*">
              <!-- Left Panel: Topic List -->
              <!-- Removed right border -->
              <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="0" MinWidth="200">
                  <TreeView ItemsSource="{Binding TopicTreeNodes}"
                            SelectedItem="{Binding SelectedNode, Mode=TwoWay}"
                            Margin="5">
                      <TreeView.ItemTemplate>
                          <TreeDataTemplate  DataType="{x:Type vm:NodeViewModel}" ItemsSource="{Binding Children}">
                              <StackPanel Orientation="Horizontal" Spacing="5">
                                  <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                  <Border Background="Gray" CornerRadius="3" Padding="3,1">
                                      <TextBlock Text="{Binding MessageCount}" FontSize="10" Foreground="White" VerticalAlignment="Center"/>
                                  </Border>
                              </StackPanel>
                          </TreeDataTemplate >
                      </TreeView.ItemTemplate>
                  </TreeView>
              </Border>

              <!-- Vertical Grid Splitter -->
              <GridSplitter Grid.Column="1"
                            Width="5"
                            VerticalAlignment="Stretch"
                            HorizontalAlignment="Center"
                            Background="LightGray"
                            ResizeDirection="Columns"/>

              <!-- Right Panel: Details and History -->
              <!-- Moved this Grid to Column 2 -->
              <Grid Grid.Column="2" RowDefinitions="2*,Auto,3*">

                  <!-- Top: Message Details -->
                  <Border Grid.Row="0" BorderBrush="Gray" BorderThickness="0,0,0,1" Padding="5">
                      <ScrollViewer>
                           <TextBlock Text="{Binding MessageDetails}" TextWrapping="Wrap" FontFamily="Consolas" MinWidth="250"/>
                      </ScrollViewer>
                  </Border>

                  <!-- Middle: Horizontal Grid Splitter -->
                  <GridSplitter Grid.Row="1"
                                Height="5"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Center"
                                Background="LightGray"
                                ResizeDirection="Rows"/>

                  <!-- Bottom: Message History -->
                  <ListBox Grid.Row="2"
                           ItemsSource="{Binding MessageHistory}"
                           SelectedItem="{Binding SelectedMessage, Mode=TwoWay}"
                           Margin="5">
                      <ListBox.ItemTemplate>
                          <DataTemplate x:DataType="vm:MessageViewModel">
                              <TextBlock Text="{Binding DisplayText}" FontFamily="Consolas" MinWidth="250"/>
                          </DataTemplate>
                      </ListBox.ItemTemplate>
                  </ListBox>

              </Grid>
          </Grid> <!-- End of Main Content Grid -->

          <Panel Grid.Row="0" Grid.Column="1" IsVisible="{Binding IsSettingsVisible}" Background="{DynamicResource ApplicationBackgroundBrush}">
            <Grid ColumnDefinitions="Auto,Auto" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" Margin="5">
                <Grid.Styles>
                    <Style Selector="TextBlock">
                        <Setter Property="VerticalAlignment" Value="Center"/>
                        <Setter Property="Margin" Value="0,0,5,0"/> <!-- Right margin for labels -->
                    </Style>
                    <Style Selector="TextBox, NumericUpDown, CheckBox">
                        <Setter Property="VerticalAlignment" Value="Center"/>
                        <Setter Property="Margin" Value="0,0,0,5"/> <!-- Bottom margin for controls -->
                    </Style>
                    <Style Selector="Grid > :nth-child(n)" x:SetterTargetType="Grid">
                        <Setter Property="Grid.Column" Value="0"/> <!-- Default to first column -->
                    </Style>
                    <Style Selector="Grid > TextBox, Grid > NumericUpDown, Grid > CheckBox">
                        <Setter Property="Grid.Column" Value="1"/> <!-- Inputs go to second column -->
                    </Style>
                    <Style Selector="Grid > StackPanel" x:SetterTargetType="Grid">
                        <Setter Property="Grid.ColumnSpan" Value="2"/> <!-- Span StackPanels across columns -->
                        <Setter Property="Grid.Column" Value="0"/>
                    </Style>
                </Grid.Styles>

                <!-- Hostname -->
                <TextBlock Grid.Row="0" Grid.Column="0" Text="Hostname:"/>
                <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding Settings.Hostname, Mode=TwoWay}"/>

                <!-- Port -->
                <TextBlock Grid.Row="1" Grid.Column="0" Text="Port:"/>
                <NumericUpDown Grid.Row="1" Grid.Column="1" Value="{Binding Settings.Port, Mode=TwoWay, StringFormat=N0}" ParsingNumberStyle="Integer" Minimum="1" Maximum="65535"/>

                <!-- Client ID -->
                <TextBlock Grid.Row="2" Grid.Column="0" Text="Client ID:"/>
                <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding Settings.ClientId, Mode=TwoWay}" Watermark="(auto-generated)"/>

                <!-- Keep Alive -->
                <TextBlock Grid.Row="3" Grid.Column="0" Text="Keep Alive (s):"/>
                <NumericUpDown Grid.Row="3" Grid.Column="1" Value="{Binding Settings.KeepAliveIntervalSeconds, Mode=TwoWay, StringFormat=N0}"  ParsingNumberStyle="Integer" MinWidth="80" Minimum="0"/>
                
                <!-- Clean Session -->
                <TextBlock Grid.Row="4" Grid.Column="0" Text="Clean Session:"/>
                <CheckBox Grid.Row="4" Grid.Column="1" IsChecked="{Binding Settings.CleanSession, Mode=TwoWay}" Margin="10,0,0,0"/>

                <!-- Session Expiry -->
                <TextBlock Grid.Row="5" Grid.Column="0" Text="Session Expiry (s):"/>
                <StackPanel Grid.Row="5" Grid.Column="1" Orientation="Vertical" Spacing="5">
                    <NumericUpDown Value="{Binding Settings.SessionExpiryIntervalSeconds, Mode=TwoWay}" MinWidth="120"  FormatString="N0" Minimum="0" Watermark="(infinite)"/>
                    <TextBlock Text="(0 = expires immediately, empty = infinite)" FontSize="10"/>
                </StackPanel>
            </Grid>
        </Panel>

      </Grid> <!-- End of Main Content Area DockPanel -->
 
    </Grid> <!-- End of Main Layout Grid -->
    
 
  </Panel>
</UserControl>